const allWorks = new Set()
const allCategories = new Set()

const projectGal = document.querySelector(".gallery");
const portfolio = document.querySelector("#portfolio");
const filterContainer = document.querySelector("#filterBtnContainer");
let login = document.querySelector('#login');
const body = document.querySelector('body');
const intro = document.querySelector('#introduction');
const proTitle = document.querySelector('#projectTitle');
const token = localStorage.getItem("token");
const header = document.querySelector('header');

async function init() {
    const works = await fetchDatabaseData("works")
    for (const work of works) {
        allWorks.add(work)
    }
    const categories = await fetchDatabaseData("categories")
    for (const categorie of categories) {
        allCategories.add(categorie)
    }
    genProGal()
    if (token) {
        isConnected()
    }
    else {
        createFilter()
    }

}
init()

function isConnected() {
    login.textContent = "logout";

    // creation de la barre noir en haut avec le mode edition 
    const editor = document.createElement('div');
    editor.classList.add('editor');
    editor.innerHTML = `<div class="headmodifier"><i class="far fa-edit"></i>modifier</div>
                            <button class="btnPubli">publier les changement</button>`
    body.insertBefore(editor, header);

    // les button modifier pour la section intro et projet 
    const modify1 = document.createElement('i');
    modify1.classList.add('far', 'fa-edit'); 
    modify1.textContent = 'modifier';
   intro.appendChild(modify1)

    // button to modify the project section 
    const modify2 = document.createElement('i');
    modify2.classList.add('far', 'fa-edit'); 
    modify2.textContent = 'modifier';
    const divTM = document.createElement('div');
    divTM.classList.add("div")
    portfolio.insertBefore(divTM, filterContainer );
    divTM.appendChild(proTitle);
    divTM.appendChild(modify2);

    // click on logout
    login.addEventListener("click", (e) => {
        // suprimer le local storage et remettre le site en mode visiteur
        login.textContent = "login";
        token.remove
        
    });




}

// get works form api and make gallery be generated by javascript automaticly
async function fetchDatabaseData(type) {
    try {
        const response = await fetch(`http://localhost:5678/api/${type}`);
        return response.json()
    } catch (error) {
        console.error('Erreur lors de la récupération des données depuis l\'API:', error);
    }
}


// creation of the elements of the gallery 
function genProGal(filtre = "0") {
    projectGal.innerHTML = ""
    const fragment = document.createDocumentFragment()
    let selectedWorks = allWorks

    if (filtre != "0") {
        selectedWorks = [...allWorks].filter(work => work.categoryId == filtre);
        console.log(selectedWorks);
    }
    for (const work of selectedWorks) {
        // we build the <figure> frist
        const project = document.createElement('figure');
        project.innerHTML = `<img src="${work.imageUrl}" alt="${work.title}">
                            <figcaption>${work.title}</figcaption>`
        //now we appenchild the figure to the main gallery div
        fragment.appendChild(project);
    }
    projectGal.appendChild(fragment)
}

function createFilter() {
    const buttonAll = document.createElement("button")
    buttonAll.dataset.id = "0"
    buttonAll.textContent = "Tous"
    buttonAll.setAttribute("class", "filterBtn filterBtn_selected");
    filterContainer.appendChild(buttonAll)

    for (const category of allCategories) {
        const button = document.createElement("button");
        button.dataset.id = category.id;
        button.textContent = category.name;
        button.setAttribute("class", "filterBtn");
        filterContainer.appendChild(button);
    }

    FilterEvent()
}

function FilterEvent() {
    const filterButtons = document.querySelectorAll(".filterBtn");

    filterButtons.forEach(button => {
        button.addEventListener("click", function (e) {
            const clickedButton = e.target
            const categoryId = clickedButton.dataset.id;
            //retiré selected de l'ancien et le mettre sur le nouveau
            filterButtons.forEach(btn => {
                btn.classList.remove('filterBtn_selected');
            });
            clickedButton.classList.add('filterBtn_selected');
            genProGal(categoryId);
        });
    });
}

